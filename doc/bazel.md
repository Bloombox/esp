# Building ESP with Bazel #

## Installing Bazel ##

On Mac OS X, install:

* [XCode](https://developer.apple.com/xcode/).
* [Java JDK 8](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)

On Linux, install:

    sudo apt-get install -y \
         g++ git openjdk-8-jdk openjdk-8-source \
         pkg-config unzip uuid-dev zip zlib1g-dev

Install [Bazel](http://bazel.io) version 0.3.0. Bazel is under active
development and from time to time, ESP continuous integration systems
are upgraded to new version of Bazel. Currently, ESP requires Bazel 0.3.0.

The version of Bazel used by ESP continuous integration systems can be
found in [script/linux-install-software](/script/linux-install-software)
variable `BAZEL_VERSION=<SHA>`.

For more details on installing Bazel, refer to [Bazel documentation
](http://bazel.io/docs/install.html).

## Building ESP ##

Next, clone the ESP Git repository with its submodules, and build it
using Bazel:

    # Clone the ESP repository
    ESP=${PWD}/esp   # Or a directory name of your choice
    git clone https://github.com/cloudendpoints/esp

    cd esp

    # Initialize Git submodules
    git submodule update --init --recursive

    # Build ESP.
    bazel build //src/nginx/main:nginx-esp

    # Run ESP tests.
    bazel test //src/... //third_party:all


The ESP binary was generated by the build in:

    bazel-bin/src/nginx/main/nginx-esp

## Running ASAN and TSAN tests ##

ASAN works on both Linux and Mac, but TSAN only works on Linux.

    # Run ASAN
    bazel test --config=asan --test_tag_filters=-no_asan \
      //src/... //third_party:all

    # Run TSAN
    bazel test --config=tsan --test_tag_filters=-no_tsan \
      //src/... //third_party:all

If you know a test is not going to work under TSAN or ASAN, please add the
`no_tsan` or `no_asan` flags to your test targets as well as a reference
to the existing bug.

## Running Endpoints Server Proxy ##

Next, proceed to [running ESP](/doc/running.md).

